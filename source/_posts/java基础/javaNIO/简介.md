---
title: java nio 简介
date: 2018/3/16 08:28:25
category:
- java基础
- javaNIO
tag:
- nio 
comments: true  
---

# 简述 #

### I/O与CPU时间的比较 ###
影响应用程序执行效率的限定性因素，往往并非处理速率，而是 I/O

提高cpu速度和io速度对吞吐量的影响
![](http://i.imgur.com/MMRW69G.jpg)

### CPU不再是束缚 ###
Java 应用程序并非真的受着 I/O 的束缚。操作系统与 Java 基于流的 I/O模型有些不匹配。操作系统要移动的是大块数据（缓冲区），JVM 的 I/O 类喜欢操作小块数据——单个字节、几行文本。结果，操作系统送来整缓冲区的数据，java.io 的流数据类再花大量时间把它们拆成小块，往往拷贝一
个小块就要往返于几层对象。

#IO概念#
##缓冲区操作 ##
所谓“输入／输出”讲的无非就是把数据移进或移出缓冲区。

进程执行 I/O 操作，归结起来，也就是向操作系统发出请求，让它要么把缓冲区里的数据排干（写），要么用数据把缓冲区填满（读）。进程使用这一机制处理所有数据进出操作.

![](http://i.imgur.com/3JmBdRQ.jpg)

注意图中用户空间和内核空间的概念。用户空间是常规进程所在区域。JVM 就是常规进程，驻守于用户空间。用户空间是非特权区域：比如，在该区域执行的代码就不能直接访问硬件设备。内核空间是操作系统所在区域。内核代码有特别的权力：它能与设备控制器通讯，控制着用户区域进程的运行状态，等等。最重要的是，所有 I/O 都直接或间接通过内核空间。

当进程请求 I/O 操作的时候，它执行一个系统调用（有时称为陷阱）将控制权移交给内核。当内核以这种方式被调用，它随即找到进程所需数据，并把数据传送到用户空间内的指定缓冲区。内核试图对数据进行高速缓存或预读取，因此进程所需数据可能已经在内核空间里了。如果是这样，该数据只需简单地拷贝出来即可。如果数据不在内核空间，则进程被挂起，内核着手把数据读进内存。

为什么不直接让磁盘控制器把数据送到用户空间的缓冲区呢?

- 硬件通常不能直接访问用户空间
- 其次，像磁盘这样基于块存储的硬件设备操作的是固定大小的数据块，而用户进程请求的可能是任意大小的或非对齐的数据块。在数据往来于用户空间与存储设备的过程中，内核负责数据的分解、再组合工作，因此充当着中间人的角色。

### 发散/汇聚 ###
操作系统能把组装／分解过程进行得更加高效。根据发散／汇聚的概念，进程只需一个系统调用，就能把一连串缓冲区地址传递给操作系统。然后，内核就可以顺序填充或排干多个缓冲区，读的时候就把数据发散到多个用户空间缓冲区，写的时候再从多个缓冲区把数据汇聚起来

![](http://i.imgur.com/KK4QJhN.jpg)

## 虚拟内存 ##



虚拟内存意为使用虚假（或虚拟）地址取代物理（硬件RAM）内存地址, 这样做好处颇多，总结起来可分为两大类：

1. 一个以上的虚拟地址可指向同一个物理内存地址。
2. 虚拟内存空间可大于实际可用的硬件内存。

设备控制器不能通过 DMA 直接存储到用户空间，但通过利用上面提到的第一项，则可以达到相同效果。把内核空间地址与用户空间的虚拟地址映射到同一个物理地址，这样，DMA 硬件（只能访问物理内存地址）就可以填充对内核与用户空间进程同时可见的缓冲区

![](http://i.imgur.com/8kJsfWb.jpg)

### 内存页面调度  ###
结构

![](http://i.imgur.com/Uy3pXmF.jpg)

地址翻译

![](http://i.imgur.com/ZSRwLoq.jpg)

结合高速缓存和虚存

![](http://i.imgur.com/4NyidgZ.jpg)

## 文件IO ##
所有 I/O 都是通过请求页面调度完成的。页面调度是非常底层的操作，仅发生于磁盘扇区与内存页之间的直接传输。而文件 I/O 则可以任意大小、任意定位。文件系统把一连串大小一致的数据块组织到一起。有些块存储元信息，如空闲块、目录、索引等的映射，有些包含文件数据。单个文件的元信息描述了哪些块包含文件数据、数据在哪里结束、最后一次更新是什么时候，等等。

采用分页技术的操作系统执行 I/O 的全过程可总结为以下几步：

 - 确定请求的数据分布在文件系统的哪些页（磁盘扇区组）。
- 在内核空间分配足够数量的内存页，以容纳得到确定的文件系统页。
- 在内存页与磁盘上的文件系统页之间建立映射。
- 为每一个内存页产生页错误。
- 虚拟内存系统俘获页错误，安排页面调入，从磁盘上读取页内容，使页有效。
- 一旦页面调入操作完成，文件系统即对原始数据进行解析，取得所需文件内容或属性
- 信息。

### 内存映射文件 ###
![](http://i.imgur.com/wGWY4Om.jpg)

内存映射 I/O 使用文件系统建立从用户空间直到可用文件系统页的虚拟内存映射。这样做有几
个好处：

- 用户进程把文件数据当作内存，所以无需发布 read( )或 write( )系统调用。
- 当用户进程碰触到映射内存空间，页错误会自动产生，从而将文件数据从磁盘读进内存。如果用户修改了映射内存空间，相关页会自动标记为脏，随后刷新到磁盘，文件得到更新。
- 操作系统的虚拟内存子系统会对页进行智能高速缓存，自动根据系统负载进行内存管
- 数据总是按页对齐的，无需执行缓冲区拷贝。
- 大型文件使用映射，无需耗费大量内存，即可进行数据拷贝。

### 文件锁定 ###
文件锁定机制允许一个进程阻止其他进程存取某文件，或限制其存取方式。通常的用途是控制共享信息的更新方式，或用于事务隔离。

## 流I/O ##
并非所有 I/O 都像前几节讲的是面向块的，也有流 I/O，其原理模仿了通道。I/O 字节流必须顺
序存取，常见的例子有 TTY（控制台）设备、打印机端口和网络连接。